<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AI ê¸°ë°˜ ì™¸ëª¨ í‰ê°€ | Binary World</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="AIê°€ ì–¼êµ´ì„ ë¶„ì„í•˜ì—¬ ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ í‰ê°€í•´ë“œë¦½ë‹ˆë‹¤. ì§€ê¸ˆ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ì¬ë¯¸ìˆëŠ” ì™¸ëª¨ í…ŒìŠ¤íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”!">
    <meta name="keywords" content="AI ì™¸ëª¨ í‰ê°€, ì–¼êµ´ ë¶„ì„, AI ì–¼êµ´ ì ìˆ˜, ì´ë¯¸ì§€ í‰ê°€, ì™¸ëª¨ í…ŒìŠ¤íŠ¸, ë§¤ë ¥ë„ í…ŒìŠ¤íŠ¸, AI ì‚¬ì§„ ë¶„ì„, ë¹„ì£¼ì–¼ í…ŒìŠ¤íŠ¸">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Binary World">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://face.binaryworld.kr">
    <meta property="og:title" content="AI ì™¸ëª¨ í‰ê°€ | ë‹¹ì‹ ì˜ ë§¤ë ¥ì€ ëª‡ ì ?">
    <meta property="og:description" content="AIê°€ ì–¼êµ´ì„ ë³´ê³  í‰ê°€í•©ë‹ˆë‹¤! ì§€ê¸ˆ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ì¬ë¯¸ìˆëŠ” ë¹„ì£¼ì–¼ í…ŒìŠ¤íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”.">
    <meta property="og:image" content="https://face.binaryworld.kr/img/radish.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI ì™¸ëª¨ í‰ê°€ | ë‹¹ì‹ ì˜ ë§¤ë ¥ì€ ëª‡ ì ?">
    <meta name="twitter:description" content="ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ AIê°€ ë‹¹ì‹ ì˜ ì™¸ëª¨ ì ìˆ˜ë¥¼ ë§¤ê²¨ë“œë¦½ë‹ˆë‹¤! ì§€ê¸ˆ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.">
    <meta name="twitter:image" content="https://face.binaryworld.kr/img/radish.png">

    <!-- âœ… íŒŒë¹„ì½˜ (ëª¨ë“  ë””ë°”ì´ìŠ¤ìš© í¬í•¨) -->
    <link rel="icon" href="/img/favicon/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/img/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- CSRF (Spring Security) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- âœ… Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto&display=swap" rel="stylesheet">
    <link id="theme-style" rel="stylesheet" th:href="@{/css/main-light.css}">

    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6890085609044109"
            crossorigin="anonymous"></script>
</head>
<body>

<th:block th:include="common/header"></th:block>

<div class="page-title">
    <h1>AI ê¸°ë°˜ ì™¸ëª¨ í‰ê°€ | Binary World</h1>
    <p>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ì¬ë¯¸ìˆëŠ” ë¹„ì£¼ì–¼ í…ŒìŠ¤íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”!</p>
</div>

<div class="container-face">
    <form id="upload-form" enctype="multipart/form-data" class="upload-form">
        <label for="file-input" class="upload-button">ğŸ“· ì–¼êµ´ ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸°</label>
        <input type="file" id="file-input" name="image" accept="image/*" onchange="previewImage(event)">
    </form>

    <div class="preview-container">
        <img id="preview" class="image-preview" style="display: none;" alt="ë¯¸ë¦¬ë³´ê¸°">
    </div>

    <div class="example-images">
        <ul>
            <li><a href="#" onclick="showExampleImage('example1.png')">ì˜ˆì‹œ1</a></li>
            <li><a href="#" onclick="showExampleImage('example2.png')">ì˜ˆì‹œ2</a></li>
            <li><a href="#" onclick="showExampleImage('example3.png')">ì˜ˆì‹œ3</a></li>
        </ul>
    </div>

    <div id="loading-spinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>AIê°€ ì–¼êµ´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
    </div>

    <div class="result-content" style="display: none;">
        <p class="result-nickname"></p>
        <p class="result-evaluation"></p>
        <p class="result-celebrity"></p>
        <p class="result-score"></p>
    </div>

    <div class="icon-container">
        <a id="btnTwitter" class="link-icon twitter" href="javascript:shareTwitter();"></a>
        <a id="btnFacebook" class="link-icon facebook" href="javascript:shareFacebook();"></a>
        <a id="btnKakao" class="link-icon kakao" href="javascript:shareKakao();"></a>
    </div>

    <div class="balance-container">
        <p>ì”ì•¡: <span id="remaining-balance">0.00</span> $</p>
        <p class="loading-message">â€» ì”ì•¡ì´ ì†Œì§„ë˜ë©´ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<!-- ì˜ˆì‹œ ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="modalImage" class="modal-image" alt="ì˜ˆì‹œ ì´ë¯¸ì§€">
    </div>
</div>

<!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ -->
<div id="custom-alert" class="custom-alert">
    <div class="custom-alert-content">
        <p id="custom-alert-message"></p>
        <button onclick="closeCustomAlert()">í™•ì¸</button>
    </div>
</div>

<div class="guestbook">
    <h2>ğŸ“– ë°©ëª…ë¡</h2>

    <form class="guestbook-form">
        <input type="text" placeholder="ë‹‰ë„¤ì„" class="guestbook-nickname" required>
        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="guestbook-password" required>
        <textarea placeholder="ë°©ë¬¸í•œ ì†Œê°ì„ ë‚¨ê²¨ì£¼ì„¸ìš” ğŸ˜Š" class="guestbook-message" required></textarea>
        <button type="submit" class="guestbook-submit">ë“±ë¡</button>
    </form>

    <ul class="guestbook-list">
    </ul>

    <div class="guestbook-pagination">
        <button id="prevPage">ì´ì „</button>
        <span id="pageInfo">1</span>
        <button id="nextPage">ë‹¤ìŒ</button>
    </div>
</div>

<th:block th:include="common/footer"></th:block>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. í–„ë²„ê±° ë©”ë‰´ í† ê¸€
        const toggleBtn = document.querySelector('.nav-toggle');
        const nav = document.querySelector('.nav-links');

        if (toggleBtn && nav) {
            toggleBtn.addEventListener('click', () => {
                toggleBtn.classList.toggle('active');
                nav.classList.toggle('open');
            });
        }

        // 2. í…Œë§ˆ í† ê¸€
        const themeToggle = document.getElementById('themeToggle');
        const themeLink = document.getElementById('theme-style');
        const currentTheme = localStorage.getItem('theme') || 'dark';

        applyTheme(currentTheme);

        if (themeToggle && themeLink) {
            themeToggle.addEventListener('click', () => {
                const isDark = themeLink.getAttribute('href').includes('dark');
                const nextTheme = isDark ? 'light' : 'dark';
                applyTheme(nextTheme);
            });
        }

        function applyTheme(theme) {
            themeLink.setAttribute('href', `/css/main-${theme}.css`);
            localStorage.setItem('theme', theme);
        }

        let currentPage = 0;
        let pageSize = 5;

        let form = document.querySelector('.guestbook-form');
        let list = document.querySelector('.guestbook-list');

        // 1. ë°©ëª…ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadGuestbook() {
            fetch('/api/guestbook')
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = '';
                    data.forEach(item => {
                        let li = document.createElement('li');
                        li.className = 'guestbook-item';
                        li.innerHTML = `
            <div class="guestbook-header">
              <strong class="guestbook-name">${item.nickname}</strong>
              <span class="guestbook-date">${item.createdAt?.substring(0, 10)}</span>
            </div>
            <p class="guestbook-content">${item.content}</p>
            <button class="guestbook-delete" data-id="${item.id}">ì‚­ì œ</button>
          `;
                        list.appendChild(li);
                    });
                })
                .catch(err => {
                    console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
                    alert('ë°©ëª…ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                });
        }

        loadGuestbook(); // ì´ˆê¸° ë¡œë”©

        // 2. ë“±ë¡ ì´ë²¤íŠ¸
        form.addEventListener('submit', e => {
            e.preventDefault();
            let nickname = form.querySelector('.guestbook-nickname').value.trim();
            let password = form.querySelector('.guestbook-password').value.trim();
            let content = form.querySelector('.guestbook-message').value.trim();

            if (!nickname || !password || !content) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (nickname.length > 10) {
                alert('ë‹‰ë„¤ì„ì€ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (password.length > 20) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 20ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (content.length > 1000) {
                alert('ë‚´ìš©ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 1000ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch('/api/guestbook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname, password, content })
            }).then(res => {
                if (res.ok) {
                    form.reset();
                    loadGuestbookPage(0);
                } else {
                    alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // 3. ì‚­ì œ ì´ë²¤íŠ¸ (ë²„íŠ¼ í´ë¦­ ì‹œ)
        list.addEventListener('click', e => {
            if (e.target.classList.contains('guestbook-delete')) {
                let id = e.target.dataset.id;
                let pw = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                if (!pw) return;

                fetch(`/api/guestbook/${id}?password=${encodeURIComponent(pw)}`, {
                    method: 'DELETE'
                }).then(res => {
                    if (res.ok) {
                        loadGuestbookPage(0);
                    } else {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                    }
                });
            }
        });

        // 4. í˜ì´ì§•
        function loadGuestbookPage(page = 0) {
            fetch(`/api/guestbook/paged?page=${page}&size=${pageSize}`)
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = '';
                    data.content.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'guestbook-item';
                        li.innerHTML = `
          <div class="guestbook-header">
            <strong class="guestbook-name">${item.nickname}</strong>
            <span class="guestbook-date">${item.createdAt?.substring(0, 10)}</span>
          </div>
          <p class="guestbook-content">${item.content}</p>
          <button class="guestbook-delete" data-id="${item.id}">ì‚­ì œ</button>
        `;
                        list.appendChild(li);
                    });

                    currentPage = data.number;
                    document.getElementById('pageInfo').textContent = `${currentPage + 1}`;
                    document.getElementById('prevPage').disabled = data.first;
                    document.getElementById('nextPage').disabled = data.last;
                });
        }

        // í˜ì´ì§€ ì´ë™ ë²„íŠ¼
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 0) loadGuestbookPage(currentPage - 1);
        });
        document.getElementById('nextPage').addEventListener('click', () => {
            loadGuestbookPage(currentPage + 1);
        });

        // ì´ˆê¸° ë¡œë”©
        loadGuestbookPage();
    });

    function shareTwitter() {
        var sendText = "AI ì™¸ëª¨ ì‹¬ì‚¬";
        var sendUrl = "https://face.binaryworld.kr";
        window.open("https://twitter.com/intent/tweet?text=" + sendText + "&url=" + sendUrl);
    }

    function shareFacebook() {
        var sendUrl = "https://face.binaryworld.kr";
        window.open("http://www.facebook.com/sharer/sharer.php?u=" + sendUrl);
    }

    function setupKakaoShareButton() {
        if (!window.Kakao) return;
        if (!document.querySelector('#btnKakao')) return;

        if (!Kakao.isInitialized()) {
            Kakao.init('8b68c737be6b8e9a8007c61ee6f9b8da');
        }

        Kakao.Share.createDefaultButton({
            container: '#btnKakao',
            objectType: 'feed',
            content: {
                title: 'ì˜¤ëŠ˜ì˜ ë¹„ì£¼ì–¼',
                description: 'AI ì™¸ëª¨ í‰ê°€ë¡œ ì¹œêµ¬ë“¤ê³¼ ìˆ ê°’ ë‚´ê¸° í•œ íŒ ì–´ë– ì‹ ì§€? ^^',
                imageUrl: 'https://face.binaryworld.kr/img/radish.png',
                link: {
                    mobileWebUrl: 'https://face.binaryworld.kr',
                    webUrl: 'https://face.binaryworld.kr'
                }
            }
        });
    }

    setupKakaoShareButton();

    function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í›„ API ìš”ì²­
            uploadImages();
        }
    }

    function showCustomAlert(message) {
        document.getElementById("custom-alert-message").innerText = message;
        document.getElementById("custom-alert").style.display = "flex";
    }

    function closeCustomAlert() {
        document.getElementById("custom-alert").style.display = "none";
    }

    async function uploadImages() {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        const resultContents = document.getElementsByClassName('result-content');
        const loadingSpinner = document.querySelector('.loading-spinner');

        loadingSpinner.style.display = 'block';

        for (let i = 0; i < fileInputs.length; i++) {
            const file = fileInputs[i].files[0];
            if (file) {
                const formData = new FormData();
                formData.append('images', file);

                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const headers = {};
                headers[csrfHeader] = csrfToken;

                try {
                    const response = await fetch('/api/evaluate', {
                        method: 'POST',
                        headers: headers,
                        body: formData,
                    });

                    let data;
                    try {
                        data = await response.json();  // í•­ìƒ JSON ë³€í™˜ ì‹œë„
                    } catch (error) {
                        console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', error);
                        alert("ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // ğŸ”¹ OpenAI API ì‚¬ìš©ëŸ‰ ì´ˆê³¼ ê°ì§€
                    if (data.results && data.results.length > 0 && data.results[0].includes("insufficient_quota")) {
                        showCustomAlert("ì •ë§ ë§ì€ ë¶„ë“¤ì´ ì´ìš©í•´ì£¼ì…¨ìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰\n\ní˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸ˆì•¡ì´ ì—†ìŠµë‹ˆë‹¤. âŒ\ní›„ì›ì„ í†µí•´ ì„œë¹„ìŠ¤ë¥¼ ê³„ì† ì´ìš©í•˜ì„¸ìš”!\n\n7ì²œì›ì´ë©´ ë©ë‹ˆë‹¤... ã…");
                        return;
                    }

                    if (data.results && data.results.length > 0) {
                        const resultJSON = JSON.parse(data.results[0]);
                        const resultContent = resultContents[i];

                        if (resultJSON.choices && resultJSON.choices.length > 0) {
                            const content = JSON.parse(resultJSON.choices[0].message.content);
                            const score = content.score;
                            const scoreText = document.createElement('span');
                            scoreText.className = 'score-text animated-score';
                            scoreText.textContent = getScoreMessage(score);

                            resultContent.querySelector('.result-nickname').textContent = "ë‹¹ì‹ ì€ " + content.nickname;
                            resultContent.querySelector('.result-evaluation').textContent = content.evaluation;
                            resultContent.querySelector('.result-celebrity').textContent = content.look_alike_celebrity;

                            const resultScoreElement = resultContent.querySelector('.result-score');
                            resultScoreElement.innerHTML = '';
                            resultScoreElement.appendChild(scoreText);

                            resultContent.style.display = 'block';
                        } else {
                            console.error('Unexpected data format in choices:', resultJSON);
                        }
                    } else {
                        console.error('Unexpected data format in results:', data);
                    }
                } catch (error) {
                    console.error('Error in uploadImages:', error);
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }
        }

        // ì”ì•¡ ì—…ë°ì´íŠ¸ ë¹„ë™ê¸° ì²˜ë¦¬ ì¶”ê°€
        await updateBalanceAfterUsage();
    }

    async function updateBalanceAfterUsage() {
        try {
            const response = await fetch('/api/faceEvaluate/balance');
            const data = await response.json();
            document.getElementById('remaining-balance').textContent = data.remainingBalance.toFixed(2);
        } catch (error) {
            console.error('Error updating balance:', error);
        }
    }

    function getScoreMessage(score) {
        if (score >= 9) {
            return `ğŸŒŸ ${score}ì ! ì™„ë²½í•´ìš”! ì§„ì§œ GDë„ ìš¸ê³ ê°ˆ ë¹„ì£¼ì–¼ì´ë„¤ìš”!`;
        } else if (score >= 7) {
            return `ğŸ˜ ${score}ì ! êµ‰ì¥í•´ìš”! ë‹¤ë“¤ í•œëˆˆì— ë°˜í•˜ê² ëŠ”ê±¸ìš”?`;
        } else if (score >= 5) {
            return `ğŸ˜Š ${score}ì ! ê½¤ë‚˜ ë§¤ë ¥ì ì´ì„¸ìš”!`;
        } else {
            return `ğŸ˜… ${score}ì ... ì•ìœ¼ë¡œì˜ ê°œì„  ì—¬ì§€ê°€ ìˆë„¤ìš”!`;
        }
    }
    async function fetchBalance() {
        try {
            const response = await fetch('/api/faceEvaluate/balance');
            const data = await response.json();
            console.log('data: ' + data );
            console.log('data.remainingBalance: ' + data.remainingBalance );
            document.getElementById('remaining-balance').textContent = data.remainingBalance.toFixed(2);
        } catch (error) {
            console.error('Error fetching balance:', error);
        }
    }


    function showExampleImage(imageName) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // static/img ê²½ë¡œ ì„¤ì •
        const imagePath = `/img/${imageName}`;

        // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
        modalImage.src = imagePath;

        // ëª¨ë‹¬ í‘œì‹œ
        modal.style.display = 'block';
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function (event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    document.addEventListener('DOMContentLoaded', fetchBalance);
</script>

</body>
</html>
